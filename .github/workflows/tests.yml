name: Django Tests with Allure Reports

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django allure-pytest coverage

      - name: Set Django settings
        run: |
          echo "DJANGO_SETTINGS_MODULE=NovaBack.settings" >> $GITHUB_ENV

      - name: Run Django tests with coverage
        run: |
          coverage run manage.py test
          coverage xml -o tests/results/coverage.xml

      - name: Download latest Allure CLI
        run: |
          # Obtener la última versión
          LATEST=$(curl -s https://api.github.com/repos/allure-framework/allure2/releases/latest | grep '"tag_name":' | sed -E 's/.*"v?([^"]+)".*/\1/')
          echo "Latest Allure version: $LATEST"
          # Descargar y descomprimir
          wget -O allure.zip https://github.com/allure-framework/allure2/releases/download/$LATEST/allure-$LATEST.zip
          unzip -q allure.zip -d allure
          # Agregar binario a PATH
          echo "$PWD/allure/allure-$LATEST/bin" >> $GITHUB_PATH

      - name: Verify Allure installation
        run: |
          allure --version

      - name: Run pytest with Allure
        run: |
          pytest NovaBack --alluredir=tests/results/allure_raw

      - name: Generate Allure Report
        run: |
          allure generate tests/results/allure_raw --clean -o tests/results/allure
